{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2>Чат с {{ target_user }}</h2>
    <div class="chat-container">
        <!-- История сообщений -->
        <div class="chat-history" id="chat-history">
            {% for sender_id, message, timestamp in messages %}
                <div class="message {% if sender_id == current_user_id %}my-message{% else %}their-message{% endif %}">
                    <p><strong>{{ 'Вы' if sender_id == current_user_id else target_user }}:</strong> {{ message }}</p>
                    <span class="timestamp">{{ timestamp }}</span>
                </div>
            {% endfor %}
        </div>

        <!-- Уведомления -->
        <div id="chat-notifications"></div>

        <!-- Форма отправки сообщения -->
        <form id="chat-form" class="chat-form">
            <input 
                type="text" 
                id="message" 
                class="chat-input" 
                placeholder="Введите сообщение..." 
                autocomplete="off" 
                required>
            <button type="submit" class="chat-send-btn">Отправить</button>
        </form>
    </div>
</div>

<!-- Подключаем скрипты -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.min.js"></script>
<script>
    const socket = io.connect();
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message');
    const chatHistory = document.getElementById('chat-history');
    const chatNotifications = document.getElementById('chat-notifications');

    const room = `chat_{{ min(current_user_id, target_user_id) }}_{{ max(current_user_id, target_user_id) }}`;

    // Подключаемся к комнате
    socket.emit('join', { room, username: "{{ current_user }}" });

    // Обработка входа в комнату
    socket.on('user_joined', function(data) {
        const notification = document.createElement('div');
        notification.classList.add('notification');
        notification.textContent = `${data.username} подключился. Вы можете начать общение.`;
        chatNotifications.appendChild(notification);

        // Автопрокрутка
        chatNotifications.scrollTop = chatNotifications.scrollHeight;
    });

    // Обработка отправки сообщения
    chatForm.onsubmit = function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();

        if (message) {
            // Отправляем сообщение на сервер
            socket.emit('send_message', { 
                room, 
                sender: "{{ current_user }}", 
                message: message 
            });

            // Добавляем сообщение в интерфейс
            const newMessage = document.createElement('div');
            newMessage.classList.add('message', 'my-message');
            newMessage.innerHTML = `
                <p><strong>Вы:</strong> ${message}</p>
                <span class="timestamp">${new Date().toLocaleString()}</span>
            `;
            chatHistory.appendChild(newMessage);

            // Очищаем поле ввода и прокручиваем вниз
            messageInput.value = '';
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
    };

    // Получаем новое сообщение
    socket.on('receive_message', function(data) {
        const newMessage = document.createElement('div');
        newMessage.classList.add('message', 'their-message');
        newMessage.innerHTML = `
            <p><strong>${data.sender}:</strong> ${data.message}</p>
            <span class="timestamp">${new Date().toLocaleString()}</span>
        `;
        chatHistory.appendChild(newMessage);

        // Автопрокрутка вниз
        chatHistory.scrollTop = chatHistory.scrollHeight;
    });
</script>
{% endblock %}
