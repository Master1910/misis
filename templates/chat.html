{% extends "base.html" %}

{% block content %}
<div class="container fade">
    <h2>Чат с {{ target_user }}</h2>

    <!-- История сообщений -->
    <div class="chat-history" id="chat-history" data-chat-id="{{ chat_id }}">
        {% for message in messages %}
        <div class="message {% if message.sender_id == current_user_id %}sent{% else %}received{% endif %}">
            <p>
                <strong>
                    {% if message.sender_id == current_user_id %} Вы {% else %} {{ message.sender }} {% endif %}
                </strong>: {{ message.message }}
            </p>
        </div>
        {% endfor %}
    </div>

    <!-- Форма отправки сообщения -->
    <form id="chat-form" action="javascript:void(0);">
        <input 
            type="text" 
            id="message-input" 
            placeholder="Введите сообщение..." 
            autocomplete="off" 
            required>
        <button type="submit">Отправить</button>
    </form>
</div>

<!-- Подключение Socket.IO -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const chatHistory = document.getElementById("chat-history");
    const chatForm = document.getElementById("chat-form");
    const messageInput = document.getElementById("message-input");

    const chatId = chatHistory.dataset.chatId;
    const currentUserId = {{ current_user_id | tojson }};  // Передаем current_user_id из шаблона
    const targetUser = "{{ target_user }}";

    if (!chatId || !chatHistory || !chatForm || !messageInput) {
        console.error("Ошибка: элементы чата не найдены.");
        return;
    }

    const socket = io.connect();

    // Обработчик отправки сообщений
    chatForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const messageText = messageInput.value.trim();

        if (messageText) {
            socket.emit("send_message", {
                chat_id: chatId,
                sender_id: currentUserId,
                receiver: targetUser,
                message: messageText,
            });

            addMessageToChat("Вы", messageText, true);
            messageInput.value = "";
        }
    });

    // Обработка входящих сообщений
    socket.on("receive_message", (data) => {
        if (data && data.message) {
            const senderName = data.sender_id === currentUserId ? "Вы" : data.sender;
            addMessageToChat(senderName, data.message, data.sender_id === currentUserId);
        }
    });

    // Добавление сообщений в чат
    function addMessageToChat(sender, text, isUser) {
        const messageClass = isUser ? "message sent" : "message received";
        const newMessage = `
            <div class="${messageClass}">
                <p><strong>${sender}:</strong> ${text}</p>
            </div>
        `;
        chatHistory.insertAdjacentHTML("beforeend", newMessage);
        scrollChatToBottom();
    }

    // Прокрутка истории чата вниз
    function scrollChatToBottom() {
        chatHistory.scrollTo({
            top: chatHistory.scrollHeight,
            behavior: "smooth",
        });
    }

    // Подключение к чату
    socket.emit("join_chat", { chat_id: chatId });
});
</script>

{% endblock %}
